{% extends "base.html" %}

{% block title %}상품 수정{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto py-8">

  <h1 class="text-2xl font-bold mb-6">상품 수정</h1>

  <form id="product_edit_form"
        method="post"
        action="/kiosks/{{ kiosk.id }}/products/{{ product.id }}/edit"
        enctype="multipart/form-data"
        class="bg-white shadow rounded-xl p-6 space-y-4">

    <!-- 기본 정보 -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label class="block text-sm font-medium mb-1">
          상품명 <span class="text-red-500">*</span>
        </label>
        <input id="name" name="name" required
               value="{{ product.name }}"
               class="w-full border rounded-lg px-3 py-2 text-sm
                      focus:outline-none focus:ring focus:ring-blue-200" />
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">카테고리</label>
        <select name="category"
                class="w-full border rounded-lg px-3 py-2 text-sm
                       focus:outline-none focus:ring focus:ring-blue-200">
          <option value="">선택하세요</option>
          <option value="기기"
              {% if product.category == "기기" %}selected{% endif %}>
            기기
          </option>
          <option value="코일&카트리지"
              {% if product.category == "코일&카트리지" %}selected{% endif %}>
            코일&카트리지
          </option>
          <option value="액상"
              {% if product.category == "액상" %}selected{% endif %}>
            액상
          </option>
          <option value="일회용"
              {% if product.category == "일회용" %}selected{% endif %}>
            일회용
          </option>
        </select>
      </div>
    </div>

    <!-- 다국어 상품명 -->
    <div class="border rounded-xl p-4 bg-slate-50 space-y-3">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div class="flex items-center gap-3">
          <button type="button" id="btn_translate_name"
                  class="px-3 py-2 rounded-lg text-sm bg-emerald-600 text-white hover:bg-emerald-700
                         disabled:opacity-60 disabled:cursor-not-allowed">
            자동번역
          </button>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div>
          <label class="block text-xs font-medium mb-1">상품명(영어)</label>
          <input id="name_en" name="name_en"
                 value="{{ product.name_en or '' }}"
                 class="w-full border rounded-lg px-3 py-2 text-sm bg-white
                        focus:outline-none focus:ring focus:ring-blue-200" />
        </div>
        <div>
          <label class="block text-xs font-medium mb-1">상품명(중국어)</label>
          <input id="name_zh" name="name_zh"
                 value="{{ product.name_zh or '' }}"
                 class="w-full border rounded-lg px-3 py-2 text-sm bg-white
                        focus:outline-none focus:ring focus:ring-blue-200" />
        </div>
        <div>
          <label class="block text-xs font-medium mb-1">상품명(일본어)</label>
          <input id="name_ja" name="name_ja"
                 value="{{ product.name_ja or '' }}"
                 class="w-full border rounded-lg px-3 py-2 text-sm bg-white
                        focus:outline-none focus:ring focus:ring-blue-200" />
        </div>
      </div>

      <div id="i18n_status" class="text-xs text-slate-500"></div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label class="block text-sm font-medium mb-1">
          판매가(원) <span class="text-red-500">*</span>
        </label>
        <input name="price" type="number" min="0" required
               value="{{ product.price }}"
               class="w-full border rounded-lg px-3 py-2 text-sm
                      focus:outline-none focus:ring focus:ring-blue-200" />
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">상품 코드</label>
        <input name="code"
               value="{{ product.code or '' }}"
               class="w-full border rounded-lg px-3 py-2 text-sm
                      focus:outline-none focus:ring focus:ring-blue-200"
               placeholder="내부코드 / 바코드 등" />
      </div>
    </div>

    <!-- 옵션 -->
    <div class="flex items-center gap-2 mt-2">
      <input id="is_adult_only" name="is_adult_only" type="checkbox"
             class="w-4 h-4 border rounded"
             {% if product.is_adult_only %}checked{% endif %}>
      <label for="is_adult_only" class="text-sm text-slate-700">
        성인 전용 상품
      </label>
    </div>

    <div class="flex items-center gap-2 mt-1">
      <input id="is_active" name="is_active" type="checkbox"
             class="w-4 h-4 border rounded"
             {% if product.is_active %}checked{% endif %}>
      <label for="is_active" class="text-sm text-slate-700">
        판매중(비활성화시 키오스크 목록에서 숨김)
      </label>
    </div>

    <!-- 이미지 영역 -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
      <!-- 현재 상품 이미지 -->
      <div>
        <label class="block text-sm font-medium mb-2">현재 상품 이미지</label>
        {% if product.image_url %}
          <div class="border rounded-lg p-2 bg-slate-50 flex items-center justify-center">
            <img src="{{ product.image_url }}"
                 alt="상품 이미지"
                 class="max-h-48 object-contain mx-auto" />
          </div>
          <p class="mt-1 text-xs text-slate-500 break-all">
            {{ product.image_url }}
          </p>
        {% else %}
          <div class="border rounded-lg p-4 bg-slate-50 text-sm text-slate-500">
            등록된 상품 이미지가 없습니다.
          </div>
        {% endif %}

        <div class="mt-3">
          <label class="block text-sm font-medium mb-1">
            상품 이미지 변경 (선택)
          </label>
          <input type="file" name="product_image" accept="image/*"
                 class="w-full text-sm" />
          <p class="mt-1 text-xs text-slate-500">
            새 이미지를 업로드하면 기존 이미지를 대체합니다.
          </p>
        </div>
      </div>

      <!-- 현재 상세 이미지 -->
      <div>
        <label class="block text-sm font-medium mb-2">현재 상세 이미지</label>
        {% if product.detail_url %}
          <div class="border rounded-lg p-2 bg-slate-50 flex items-center justify-center">
            <img src="{{ product.detail_url }}"
                 alt="상세 이미지"
                 class="max-h-48 object-contain mx-auto" />
          </div>
          <p class="mt-1 text-xs text-slate-500 break-all">
            {{ product.detail_url }}
          </p>
        {% else %}
          <div class="border rounded-lg p-4 bg-slate-50 text-sm text-slate-500">
            등록된 상세 이미지가 없습니다.
          </div>
        {% endif %}

        <div class="mt-3">
          <label class="block text-sm font-medium mb-1">
            상세 이미지 변경 (선택)
          </label>
          <input type="file" name="detail_image" accept="image/*"
                 class="w-full text-sm" />
          <p class="mt-1 text-xs text-slate-500">
            새 이미지를 업로드하면 기존 상세 이미지를 대체합니다.
          </p>
        </div>
      </div>
    </div>

    <!-- 설명 -->
    <div>
      <label class="block text-sm font-medium mb-1">상품 설명</label>
      <textarea name="description" rows="3"
                class="w-full border rounded-lg px-3 py-2 text-sm
                       focus:outline-none focus:ring focus:ring-blue-200"
                placeholder="간단한 상품 설명을 입력하세요.">{{ product.description or "" }}</textarea>
    </div>

    <div class="flex justify-between items-center pt-4">
      <div class="text-xs text-slate-400">
        ID: {{ product.id }} • 생성일: {{ product.created_at.strftime("%Y-%m-%d") }}
      </div>
      <div class="flex gap-2">
        <a href="/kiosks/{{ kiosk.id }}?mode=edit"
           class="px-4 py-2 rounded-lg text-sm border border-slate-300
                  text-slate-700 hover:bg-slate-50">
          목록으로
        </a>

        <button type="submit"
                id="btn_submit"
                class="px-4 py-2 rounded-lg text-sm bg-blue-600 text-white
                       hover:bg-blue-700 disabled:opacity-60 disabled:cursor-not-allowed">
          저장하기
        </button>
      </div>
    </div>

  </form>

</div>

<script>
  (function () {
    // ---------- 자동번역 로딩 ----------
    const btnTranslate = document.getElementById('btn_translate_name');
    const statusEl = document.getElementById('i18n_status');
    const overwriteEl = document.getElementById('overwrite_i18n');

    const nameEl = document.getElementById('name');
    const enEl = document.getElementById('name_en');
    const zhEl = document.getElementById('name_zh');
    const jaEl = document.getElementById('name_ja');

    const endpoint = "/kiosks/{{ kiosk.id }}/products/{{ product.id }}/translate-name";

    function setStatus(msg) {
      if (statusEl) statusEl.textContent = msg || '';
    }

    function setTranslateLoading(isLoading) {
      if (!btnTranslate) return;
      const original = btnTranslate.dataset.originalText || btnTranslate.textContent;
      if (!btnTranslate.dataset.originalText) btnTranslate.dataset.originalText = original;

      btnTranslate.disabled = isLoading;
      btnTranslate.textContent = isLoading ? '번역 중...' : original;
    }

    if (btnTranslate) {
      btnTranslate.addEventListener('click', async () => {
        try {
          setTranslateLoading(true);
          setStatus('번역 중...');

          const sourceName = (nameEl?.value || '').trim();

          const res = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ source_name: sourceName })
          });

          if (!res.ok) {
            const text = await res.text();
            throw new Error(text || ('HTTP ' + res.status));
          }

          const data = await res.json();
          if (!data || !data.ok) throw new Error('번역 실패');

          const overwrite = overwriteEl ? overwriteEl.checked : true;

          if (overwrite || !(enEl?.value || '').trim()) enEl.value = data.name_en || '';
          if (overwrite || !(zhEl?.value || '').trim()) zhEl.value = data.name_zh || '';
          if (overwrite || !(jaEl?.value || '').trim()) jaEl.value = data.name_ja || '';

          setStatus('번역 완료');
        } catch (err) {
          setStatus('번역 오류: ' + (err && err.message ? err.message : String(err)));
        } finally {
          setTranslateLoading(false);
        }
      });
    }

    // ---------- 저장하기 로딩 ----------
    const form = document.getElementById('product_edit_form');
    const btnSubmit = document.getElementById('btn_submit');

    function setSubmitLoading(isLoading) {
      if (!btnSubmit) return;
      const original = btnSubmit.dataset.originalText || btnSubmit.textContent;
      if (!btnSubmit.dataset.originalText) btnSubmit.dataset.originalText = original;

      btnSubmit.disabled = isLoading;
      btnSubmit.textContent = isLoading ? '저장 중...' : original;
    }

    if (form && btnSubmit) {
      form.addEventListener('submit', () => {
        // submit 직후 즉시 로딩으로 변경 (중복 제출 방지)
        setSubmitLoading(true);
      });
    }
  })();
</script>
{% endblock %}
