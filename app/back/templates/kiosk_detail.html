{% extends "base.html" %}

{% block title %}{{ kiosk.name }} | 하드웨어 현황{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto py-8 space-y-6">
  <!-- 상단 헤더 -->
  <div class="flex items-start justify-between gap-6">
    <div>
      <h1 class="text-2xl font-bold mb-1">
        {{ kiosk.name }}
      </h1>
      <p class="text-sm text-slate-500">
        지점: {{ kiosk.store.name }} /
        코드: <span class="font-mono">{{ kiosk.code }}</span>
      </p>
      <p class="text-xs text-slate-400 mt-1">
        앱 버전:
        {% if kiosk.app_version %}
          <span class="font-mono">v{{ kiosk.app_version }}</span>
        {% else %}
          -
        {% endif %}
        · 마지막 하트비트:
        {% if kiosk.last_heartbeat_at %}
          {{ kiosk.last_heartbeat_at }}
        {% else %}
          기록 없음
        {% endif %}
      </p>
    </div>
    <!-- 배치 모드 제거: 우측 상단 비워둠 (필요시 다른 버튼 추가 가능) -->
  </div>

  <!-- 슬롯 그리드: 층별 카드 -->
  <div class="space-y-6">
    {% for layer, slots in layers %}
      <div class="bg-white shadow rounded-xl overflow-hidden">
        <!-- 층 헤더 -->
        <div class="px-4 py-2 bg-slate-100 flex items-center justify-between">
          <div class="font-semibold text-sm">
            {{ layer }}단
            {% if layer == 1 %}
              <span class="text-xs text-slate-500">(최상단)</span>
            {% endif %}
          </div>
          <div class="text-xs text-slate-400">
            슬롯 수: {{ slots|length }}
          </div>
        </div>

        <!-- 슬롯 카드 목록: 5칸 + 5칸 -->
        <div class="p-4 space-y-3">

          <!-- 1줄: 앞 5개 -->
          <div class="grid grid-cols-5 gap-3">
            {% for s in slots[:5] %}
              {% include "partials/_kiosk_slot_card.html" %}
            {% endfor %}
          </div>

          <!-- 2줄: 뒤 5개 -->
          <div class="grid grid-cols-5 gap-3">
            {% for s in slots[5:10] %}
              {% include "partials/_kiosk_slot_card.html" %}
            {% endfor %}
          </div>

        </div>
      </div>
    {% endfor %}
  </div>
</div>

<!-- 공용 슬롯 편집 모달 -->
<div id="slot-modal"
     class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-xl shadow-lg w-full max-w-md p-4 space-y-4">
    <div class="flex items-center justify-between">
      <h2 class="text-sm font-semibold">슬롯 상품 배치</h2>
      <button type="button" class="text-xs text-slate-400 js-close-slot-modal">닫기</button>
    </div>

    <form method="post" id="slot-form">
      <input type="hidden" name="slot_id" id="slot_id_input">
      <div class="text-xs text-slate-500 mb-2" id="slot_info_label"></div>

      <!-- 상품 검색 + 선택 -->
      <div class="space-y-1">
        <label class="text-[11px] text-slate-500">상품 선택</label>
        <input type="text" id="product_search"
               class="w-full border rounded px-2 py-1 text-sm mb-1"
               placeholder="상품명 검색" oninput="filterProductOptions()">

        <select name="product_id" id="product_select"
                size="8"
                class="w-full border rounded px-2 py-1 text-sm">
          {% for p in products %}
            <option value="{{ p.id }}">
              {{ p.name }} ({{ "{:,}".format(p.price) }}원)
              {% if p.is_adult %}[성인]{% endif %}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- 용량/재고 -->
      <div class="mt-3 grid grid-cols-3 gap-2">
        <div>
          <label class="text-[11px] text-slate-500">최대 수량</label>
          <input type="number" name="max_capacity" id="input_max_capacity"
                 class="w-full border rounded px-2 py-1 text-sm">
        </div>
        <div>
          <label class="text-[11px] text-slate-500">현재 재고</label>
          <input type="number" name="current_stock" id="input_current_stock"
                 class="w-full border rounded px-2 py-1 text-sm">
        </div>
        <div>
          <label class="text-[11px] text-slate-500">재고 알림</label>
          <input type="number" name="low_stock_alarm" id="input_low_stock_alarm"
                 class="w-full border rounded px-2 py-1 text-sm">
        </div>
      </div>

      <div class="mt-4 flex justify-end gap-2">
        <button type="button"
                class="px-3 py-1 text-xs rounded border js-close-slot-modal">
          취소
        </button>
        <button type="submit"
                class="px-3 py-1 text-xs rounded bg-blue-600 text-white">
          저장
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  const modal = document.getElementById('slot-modal');
  const slotIdInput = document.getElementById('slot_id_input');
  const slotInfoLabel = document.getElementById('slot_info_label');
  const slotForm = document.getElementById('slot-form');

  const inputMax = document.getElementById('input_max_capacity');
  const inputStock = document.getElementById('input_current_stock');
  const inputLow = document.getElementById('input_low_stock_alarm');
  const productSelect = document.getElementById('product_select');

  function attachSlotModalHandlers() {
    document.querySelectorAll('.js-open-slot-modal').forEach(btn => {
      btn.addEventListener('click', () => {
        const card = btn.closest('[data-slot-id]');
        const slotId = card.dataset.slotId;
        const label = card.dataset.slotLabel;
        const board = card.dataset.slotBoard;
        const max = card.dataset.slotMax || 0;
        const stock = card.dataset.slotStock || 0;
        const low = card.dataset.slotLow || 0;
        const productId = card.dataset.slotProductId;

        slotIdInput.value = slotId;
        slotInfoLabel.textContent = `${label} (보드코드: ${board})`;

        inputMax.value = max;
        inputStock.value = stock;
        inputLow.value = low;

        if (productId) {
          productSelect.value = productId;
        } else {
          productSelect.selectedIndex = -1;
        }

        slotForm.action = `/kiosks/{{ kiosk.id }}/slots/${slotId}/assign`;

        modal.classList.remove('hidden');
      });
    });
  }

  function attachSlotClearHandlers() {
    document.querySelectorAll('.js-slot-clear-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const slotId = btn.dataset.slotId;
        const ok = confirm('이 슬롯을 비우시겠습니까?');
        if (!ok) return;

        const form = document.createElement('form');
        form.method = 'post';
        form.action = `/kiosks/{{ kiosk.id }}/slots/${slotId}/clear`;

        document.body.appendChild(form);
        form.submit();
      });
    });
  }

  attachSlotModalHandlers();
  attachSlotClearHandlers();

  document.querySelectorAll('.js-close-slot-modal').forEach(btn => {
    btn.addEventListener('click', () => {
      modal.classList.add('hidden');
    });
  });

  function filterProductOptions() {
    const keyword = document.getElementById('product_search').value.toLowerCase();
    Array.from(productSelect.options).forEach(opt => {
      const text = opt.text.toLowerCase();
      opt.hidden = keyword && !text.includes(keyword);
    });
  }
</script>
{% endblock %}
