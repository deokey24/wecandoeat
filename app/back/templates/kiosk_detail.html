{% extends "base.html" %}

{% block title %}{{ kiosk.name }} | í•˜ë“œì›¨ì–´ í˜„í™©{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto py-8 space-y-6">
  <!-- ìƒë‹¨ í—¤ë” -->
  <div class="flex items-start justify-between gap-6">
    <div>
      <h1 class="text-2xl font-bold mb-1">
        {{ kiosk.name }}
      </h1>
      <p class="text-sm text-slate-500">
        ì§€ì : {{ kiosk.store.name }} /
        ì½”ë“œ: <span class="font-mono">{{ kiosk.code }}
        ì„¤ì • ë¹„ë°€ë²ˆí˜¸: <span class="font-mono">{{ kiosk.kiosk_password }}</span>
        í˜ì–´ë§ì½”ë“œ: <span class="font-mono">{{ kiosk.pair_code_4 }}</span>
      </p>
      <p class="text-xs text-slate-400 mt-1">
        ì•± ë²„ì „:
        {% if kiosk.app_version %}
          <span class="font-mono">v{{ kiosk.app_version }}</span>
        {% else %}
          -
        {% endif %}
        Â· ë§ˆì§€ë§‰ í•˜íŠ¸ë¹„íŠ¸:
        {% if kiosk.last_heartbeat_at %}
          {{ kiosk.last_heartbeat_at }}
        {% else %}
          ê¸°ë¡ ì—†ìŒ
        {% endif %}
      </p>
    </div>
    <!-- ë°°ì¹˜ ëª¨ë“œ ì œê±°: ìš°ì¸¡ ìƒë‹¨ ë¹„ì›Œë‘  (í•„ìš”ì‹œ ë‹¤ë¥¸ ë²„íŠ¼ ì¶”ê°€ ê°€ëŠ¥) -->
  </div>

  <!-- ìŠ¬ë¡¯ ê·¸ë¦¬ë“œ: ì¸µë³„ ì¹´ë“œ -->
  <div class="space-y-6">
    {% for layer, slots in layers %}
      <div class="bg-white shadow rounded-xl overflow-hidden">
        <!-- ì¸µ í—¤ë” -->
        <div class="px-4 py-2 bg-slate-100 flex items-center justify-between">
          <div class="font-semibold text-sm">
            {{ layer }}ë‹¨
            {% if layer == 1 %}
              <span class="text-xs text-slate-500">(ìµœìƒë‹¨)</span>
            {% endif %}
          </div>
          <div class="text-xs text-slate-400">
            ìŠ¬ë¡¯ ìˆ˜: {{ slots|length }}
          </div>
        </div>

        <!-- ìŠ¬ë¡¯ ì¹´ë“œ ëª©ë¡: 5ì¹¸ + 5ì¹¸ -->
        <div class="p-4 space-y-3">

          <!-- 1ì¤„: ì• 5ê°œ -->
          <div class="grid grid-cols-5 gap-3">
            {% for s in slots[:5] %}
              {% include "partials/_kiosk_slot_card.html" %}
            {% endfor %}
          </div>

          <!-- 2ì¤„: ë’¤ 5ê°œ -->
          <div class="grid grid-cols-5 gap-3">
            {% for s in slots[5:10] %}
              {% include "partials/_kiosk_slot_card.html" %}
            {% endfor %}
          </div>

        </div>
      </div>
    {% endfor %}
  </div>
  <div class="mt-8">
  <div class="flex items-center justify-between mb-3">
    <h2 class="text-lg font-semibold">ë³´í˜¸í™”ë©´ ì´ë¯¸ì§€</h2>
    <form action="/kiosks/{{ kiosk.id }}/screensaver/upload" method="post" enctype="multipart/form-data" class="flex items-center gap-2">
      <input type="file" name="file" accept="image/*"
             class="text-xs border rounded px-2 py-1" required>
      <button type="submit"
              class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium px-3 py-1.5 rounded-lg">
        ì´ë¯¸ì§€ ì¶”ê°€
      </button>
    </form>
  </div>

  {% if screen_images %}
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
      {% for img in screen_images %}
        <div class="border rounded-lg overflow-hidden bg-slate-50">
          <div class="aspect-[9/16] bg-slate-200 flex items-center justify-center">
            <img src="{{ img.image_url }}"
                 alt="screensaver {{ loop.index }}"
                 class="w-full h-full object-cover">
          </div>
          <div class="flex items-center justify-between px-2 py-1.5 text-xs">
            <span class="text-slate-600">
              #{{ img.sort_order }}
            </span>
            <form action="/kiosks/{{ kiosk.id }}/screensaver/{{ img.id }}/delete" method="post"
                  onsubmit="return confirm('ì´ ì´ë¯¸ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
              <button type="submit"
                      class="text-red-600 hover:text-red-800">
                ì‚­ì œ
              </button>
            </form>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="border rounded-lg px-4 py-6 text-sm text-slate-500 bg-slate-50">
      ë“±ë¡ëœ ë³´í˜¸í™”ë©´ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.<br>
      ìƒë‹¨ì˜ <span class="font-semibold">[ì´ë¯¸ì§€ ì¶”ê°€]</span> ë²„íŠ¼ìœ¼ë¡œ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì§€ ì•Šìœ¼ë©´
      í‚¤ì˜¤ìŠ¤í¬ ì•±ì—ì„œëŠ” ê¸°ë³¸ ë³´í˜¸í™”ë©´ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
    </div>
  {% endif %}
</div>
</div>

<!-- SLOT ASSIGN MODAL -->
<div id="slot-modal"
     class="fixed inset-0 bg-black/40 z-50 hidden
            flex items-end sm:items-center justify-center">
  <div class="bg-white w-full sm:max-w-2xl
              rounded-t-2xl sm:rounded-2xl
              shadow-lg px-4 py-4 sm:px-6 sm:py-5
              space-y-4 max-h-[90vh] overflow-y-auto">

    <!-- í—¤ë” -->
    <div class="flex items-center justify-between mb-1">
      <div>
        <h2 class="text-base sm:text-lg font-semibold">ìŠ¬ë¡¯ ìƒí’ˆ ë°°ì¹˜</h2>
        <div class="text-xs text-slate-500 mt-1" id="slot_info_label"></div>
      </div>
      <button type="button"
              class="text-xs sm:text-sm text-slate-400 hover:text-slate-600 js-close-slot-modal">
        ë‹«ê¸°
      </button>
    </div>

    <form method="post" id="slot-form" class="space-y-4">
      <input type="hidden" name="slot_id" id="slot_id_input">

      <!-- ìƒí’ˆ ê²€ìƒ‰ -->
      <div class="space-y-2">
        <label class="text-xs sm:text-sm font-medium text-slate-600">ìƒí’ˆ ì„ íƒ</label>

        <input type="text"
               id="product_search"
               placeholder="ìƒí’ˆëª…, ì½”ë“œ ê²€ìƒ‰"
               class="w-full border rounded-lg px-3 py-2 text-xs sm:text-sm"
               oninput="filterProductCards()">
      </div>

      <!-- ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ (ì´ë¯¸ì§€ í¬í•¨) -->
      <div id="product_list"
           class="grid grid-cols-2 sm:grid-cols-3 gap-3 max-h-64 overflow-y-auto pr-1">

        {% for p in products %}
        <div class="product-card border rounded-lg cursor-pointer p-2
                    hover:border-blue-500 transition-all"
             data-name="{{ p.name | lower }}"
             data-id="{{ p.id }}"
             onclick="selectProduct({{ p.id }}, this)">

          <img src="{{ p.image_url }}"
               class="w-full h-28 object-contain rounded mb-1">

          <div class="text-xs sm:text-sm font-medium text-slate-800 leading-tight">
            {{ p.name|safe }}
          </div>

          <div class="text-[11px] text-slate-500">
            {{ "{:,}".format(p.price) }}ì›
            {% if p.is_adult %}
              <span class="text-red-500 ml-1">ì„±ì¸</span>
            {% endif %}
          </div>
        </div>
        {% endfor %}

      </div>

      <!-- ì‹¤ì œ ì„ íƒ ê°’ -->
      <input type="hidden" name="product_id" id="product_select">

      <!-- ìš©ëŸ‰/ì¬ê³  -->
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
        <div>
          <label class="text-xs text-slate-500 block mb-1">ìµœëŒ€ ìˆ˜ëŸ‰</label>
          <input type="number" name="max_capacity"
                 id="input_max_capacity"
                 class="w-full border rounded-lg px-3 py-2 text-xs sm:text-sm">
        </div>
        <div>
          <label class="text-xs text-slate-500 block mb-1">í˜„ì¬ ì¬ê³ </label>
          <input type="number" name="current_stock"
                 id="input_current_stock"
                 class="w-full border rounded-lg px-3 py-2 text-xs sm:text-sm">
        </div>
        <div>
          <label class="text-xs text-slate-500 block mb-1">ì¬ê³  ì•Œë¦¼</label>
          <input type="number" name="low_stock_alarm"
                 id="input_low_stock_alarm"
                 class="w-full border rounded-lg px-3 py-2 text-xs sm:text-sm">
        </div>
      </div>

      <!-- ë²„íŠ¼ -->
      <div class="pt-1 flex flex-col sm:flex-row justify-end gap-2">
        <button type="submit"
                class="w-full sm:w-auto px-3 py-2 text-xs sm:text-sm rounded-lg
                       bg-blue-600 text-white hover:bg-blue-700">
          ì €ì¥
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  const slotModal = document.getElementById("slot-modal");
  const slotForm = document.getElementById("slot-form");
  const slotIdInput = document.getElementById("slot_id_input");
  const slotInfoLabel = document.getElementById("slot_info_label");

  const inputMax = document.getElementById("input_max_capacity");
  const inputStock = document.getElementById("input_current_stock");
  const inputLow = document.getElementById("input_low_stock_alarm");

  const productSelect = document.getElementById("product_select");

  /* ìƒí’ˆ ì„ íƒ (ìš°ì¸¡ ì¹´ë“œ í´ë¦­ ì‹œ) */
  function selectProduct(id, element) {
    // hidden inputì— ê°’ ì €ì¥
    productSelect.value = id;

    // ì „ì²´ ì¹´ë“œ reset
    document.querySelectorAll(".product-card")
      .forEach(c => c.classList.remove("ring", "ring-blue-500"));

    // ì„ íƒëœ ì¹´ë“œ ê°•ì¡°
    element.classList.add("ring", "ring-blue-500");
  }

  /* ìŠ¬ë¡¯ ëª¨ë‹¬ ì—´ê¸°/ì´ˆê¸°í™” */
  function attachSlotModalHandlers() {
    document.querySelectorAll(".js-open-slot-modal").forEach(btn => {
      btn.addEventListener("click", () => {
        const card = btn.closest("[data-slot-id]");
        if (!card) return;

        const slotId = card.dataset.slotId;
        const label = card.dataset.slotLabel;
        const board = card.dataset.slotBoard;
        const max = card.dataset.slotMax || 0;
        const stock = card.dataset.slotStock || 0;
        const low = card.dataset.slotLow || 0;
        const productId = card.dataset.slotProductId || "";

        slotIdInput.value = slotId;
        slotInfoLabel.textContent = `${label} (ë³´ë“œì½”ë“œ: ${board})`;

        inputMax.value = max;
        inputStock.value = stock;
        inputLow.value = low;

        // ë§ˆìŠ¤í„° ìƒí’ˆ select ê°’ ì´ˆê¸°í™”
        if (productId) {
          productSelect.value = productId;
        } else {
          productSelect.selectedIndex = -1;
        }

        // ğŸ”¹ ì—¬ê¸°! ìŠ¬ë¡¯ë³„ë¡œ ì˜¬ë°”ë¥¸ ë¼ìš°íŠ¸ë¡œ POST ë˜ë„ë¡ action ì„¤ì •
        slotForm.action = `/kiosks/{{ kiosk.id }}/slots/${slotId}/assign`;

        slotModal.classList.remove("hidden");
      });
    });
  }

  /* ìŠ¬ë¡¯ì— ë°°ì¹˜ëœ ìƒí’ˆ ìì²´ ìˆ˜ì • ë²„íŠ¼ í•¸ë“¤ëŸ¬ */
  function attachEditSlotProductHandlers() {
    document.querySelectorAll(".js-edit-slot-product").forEach(btn => {
      btn.addEventListener("click", () => {
        const card = btn.closest("[data-slot-id]");
        if (!card) return;

        const kioskProductId = card.dataset.kioskProductId;
        if (!kioskProductId) {
          alert("ì´ ìŠ¬ë¡¯ì—ëŠ” ì•„ì§ ìƒí’ˆì´ ë§¤í•‘ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.");
          return;
        }

        // ì„œë²„ ë¼ìš°íŠ¸: /kiosks/{kiosk_id}/products/{kiosk_product_id}/edit
        const kioskId = {{ kiosk.id }};
        window.location.href = `/kiosks/${kioskId}/products/${kioskProductId}/edit`;
      });
    });
  }

  /* ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ */
  function attachCloseModalHandlers() {
    document.querySelectorAll(".js-close-slot-modal").forEach(btn => {
      btn.addEventListener("click", () => {
        slotModal.classList.add("hidden");
      });
    });
  }

  /* ìƒí’ˆ ê²€ìƒ‰(select option í•„í„°ë§) */
  function filterProductOptions() {
    const keyword = document.getElementById("product_search").value.toLowerCase();
    Array.from(productSelect.options).forEach(opt => {
      const text = opt.text.toLowerCase();
      opt.hidden = keyword && !text.includes(keyword);
    });
  }

  // ì´ˆê¸° ë°”ì¸ë”©
  document.addEventListener("DOMContentLoaded", () => {
    attachSlotModalHandlers();
    attachEditSlotProductHandlers();
    attachCloseModalHandlers();
  });
</script>
{% endblock %}
