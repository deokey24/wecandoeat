{% extends "base.html" %}

{% block title %}{{ kiosk.name }} | í•˜ë“œì›¨ì–´ í˜„í™©{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto py-8 space-y-6">
  <!-- ìƒë‹¨ í—¤ë” -->
  <div class="flex items-start justify-between gap-6">
    <div>
      <h1 class="text-2xl font-bold mb-1">
        {{ kiosk.name }}
      </h1>
      <p class="text-sm text-slate-500">
        ì§€ì : {{ kiosk.store.name }} /
        ì½”ë“œ: <span class="font-mono">{{ kiosk.code }}
        ì„¤ì • ë¹„ë°€ë²ˆí˜¸: <span class="font-mono">{{ kiosk.kiosk_password }}</span>
        í˜ì–´ë§ì½”ë“œ: <span class="font-mono">{{ kiosk.pair_code_4 }}</span>
      </p>
      <p class="text-xs text-slate-400 mt-1">
        ì•± ë²„ì „:
        {% if kiosk.app_version %}
          <span class="font-mono">v{{ kiosk.app_version }}</span>
        {% else %}
          -
        {% endif %}
        Â· ë§ˆì§€ë§‰ í•˜íŠ¸ë¹„íŠ¸:
        {% if kiosk.last_heartbeat_at %}
          {{ kiosk.last_heartbeat_at }}
        {% else %}
          ê¸°ë¡ ì—†ìŒ
        {% endif %}
      </p>
    </div>
    <!-- ë°°ì¹˜ ëª¨ë“œ ì œê±°: ìš°ì¸¡ ìƒë‹¨ ë¹„ì›Œë‘  (í•„ìš”ì‹œ ë‹¤ë¥¸ ë²„íŠ¼ ì¶”ê°€ ê°€ëŠ¥) -->
  </div>

  <!-- ìŠ¬ë¡¯ ê·¸ë¦¬ë“œ: ì¸µë³„ ì¹´ë“œ -->
  <div class="space-y-6">
    {% for layer, slots in layers %}
      <div class="bg-white shadow rounded-xl overflow-hidden">
        <!-- ì¸µ í—¤ë” -->
        <div class="px-4 py-2 bg-slate-100 flex items-center justify-between">
          <div class="font-semibold text-sm">
            {{ layer }}ë‹¨
            {% if layer == 1 %}
              <span class="text-xs text-slate-500">(ìµœìƒë‹¨)</span>
            {% endif %}
          </div>
          <div class="text-xs text-slate-400">
            ìŠ¬ë¡¯ ìˆ˜: {{ slots|length }}
          </div>
        </div>

        <!-- ìŠ¬ë¡¯ ì¹´ë“œ ëª©ë¡: 5ì¹¸ + 5ì¹¸ -->
        <div class="p-4 space-y-3">

          <!-- 1ì¤„: ì• 5ê°œ -->
          <div class="grid grid-cols-5 gap-3">
            {% for s in slots[:5] %}
              {% include "partials/_kiosk_slot_card.html" %}
            {% endfor %}
          </div>

          <!-- 2ì¤„: ë’¤ 5ê°œ -->
          <div class="grid grid-cols-5 gap-3">
            {% for s in slots[5:10] %}
              {% include "partials/_kiosk_slot_card.html" %}
            {% endfor %}
          </div>

        </div>
      </div>
    {% endfor %}
  </div>
  <div class="mt-8">
  <div class="flex items-center justify-between mb-3">
    <h2 class="text-lg font-semibold">ë³´í˜¸í™”ë©´ ì´ë¯¸ì§€</h2>
    <form action="/kiosks/{{ kiosk.id }}/screensaver/upload" method="post" enctype="multipart/form-data" class="flex items-center gap-2">
      <input type="file" name="file" accept="image/*"
             class="text-xs border rounded px-2 py-1" required>
      <button type="submit"
              class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium px-3 py-1.5 rounded-lg">
        ì´ë¯¸ì§€ ì¶”ê°€
      </button>
    </form>
  </div>

  {% if screen_images %}
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
      {% for img in screen_images %}
        <div class="border rounded-lg overflow-hidden bg-slate-50">
          <div class="aspect-[9/16] bg-slate-200 flex items-center justify-center">
            <img src="{{ img.image_url }}"
                 alt="screensaver {{ loop.index }}"
                 class="w-full h-full object-cover">
          </div>
          <div class="flex items-center justify-between px-2 py-1.5 text-xs">
            <span class="text-slate-600">
              #{{ img.sort_order }}
            </span>
            <form action="/kiosks/{{ kiosk.id }}/screensaver/{{ img.id }}/delete" method="post"
                  onsubmit="return confirm('ì´ ì´ë¯¸ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
              <button type="submit"
                      class="text-red-600 hover:text-red-800">
                ì‚­ì œ
              </button>
            </form>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="border rounded-lg px-4 py-6 text-sm text-slate-500 bg-slate-50">
      ë“±ë¡ëœ ë³´í˜¸í™”ë©´ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.<br>
      ìƒë‹¨ì˜ <span class="font-semibold">[ì´ë¯¸ì§€ ì¶”ê°€]</span> ë²„íŠ¼ìœ¼ë¡œ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì§€ ì•Šìœ¼ë©´
      í‚¤ì˜¤ìŠ¤í¬ ì•±ì—ì„œëŠ” ê¸°ë³¸ ë³´í˜¸í™”ë©´ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
    </div>
  {% endif %}
</div>
</div>

<!-- SLOT ASSIGN MODAL -->
<div id="slot-modal"
     class="fixed inset-0 bg-black/40 z-50 hidden
            flex items-end sm:items-center justify-center">
  <div class="bg-white w-full sm:max-w-2xl
              rounded-t-2xl sm:rounded-2xl
              shadow-lg px-4 py-4 sm:px-6 sm:py-5
              space-y-4 max-h-[90vh] overflow-y-auto">

    <!-- í—¤ë” -->
    <div class="flex items-center justify-between mb-1">
      <div>
        <h2 class="text-base sm:text-lg font-semibold">ìŠ¬ë¡¯ ìƒí’ˆ ë°°ì¹˜</h2>
        <div class="text-xs text-slate-500 mt-1" id="slot_info_label"></div>
      </div>
      <button type="button"
              class="text-xs sm:text-sm text-slate-400 hover:text-slate-600 js-close-slot-modal">
        ë‹«ê¸°
      </button>
    </div>

    <form method="post" id="slot-form" class="space-y-4">
      <input type="hidden" name="slot_id" id="slot_id_input">

      <!-- ìƒí’ˆ ê²€ìƒ‰ -->
      <div class="space-y-2">
        <label class="text-xs sm:text-sm font-medium text-slate-600">ìƒí’ˆ ì„ íƒ</label>

        <input type="text"
               id="product_search"
               placeholder="ìƒí’ˆëª…, ì½”ë“œ ê²€ìƒ‰"
               class="w-full border rounded-lg px-3 py-2 text-xs sm:text-sm"
               oninput="filterProductCards()">
      </div>

      <!-- ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ (ì´ë¯¸ì§€ í¬í•¨) -->
      <div id="product_list"
           class="grid grid-cols-2 sm:grid-cols-3 gap-3 max-h-64 overflow-y-auto pr-1">

        {% for p in products %}
        <div class="product-card border rounded-lg cursor-pointer p-2
                    hover:border-blue-500 transition-all"
             data-name="{{ p.name | lower }}"
             data-id="{{ p.id }}"
             onclick="selectProduct({{ p.id }}, this)">

          <img src="{{ p.image_url }}"
               class="w-full h-28 object-contain rounded mb-1">

          <div class="text-xs sm:text-sm font-medium text-slate-800 leading-tight">
            {{ p.name|safe }}
          </div>

          <div class="text-[11px] text-slate-500">
            {{ "{:,}".format(p.price) }}ì›
            {% if p.is_adult %}
              <span class="text-red-500 ml-1">ì„±ì¸</span>
            {% endif %}
          </div>
        </div>
        {% endfor %}

      </div>

      <!-- ì‹¤ì œ ì„ íƒ ê°’ -->
      <input type="hidden" name="product_id" id="product_select">

      <!-- ì¬ê³  ì„¤ì • ì•ˆë‚´ -->
      <div class="p-3 bg-slate-50 border rounded-lg text-xs sm:text-sm text-slate-600">
        ì¬ê³ ëŠ” í‚¤ì˜¤ìŠ¤í¬ ê¸°ê¸°ì—ì„œë§Œ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      </div>

      <!-- ë²„íŠ¼ -->
      <div class="pt-1 flex flex-col sm:flex-row justify-end gap-2">
        <button type="submit"
                class="w-full sm:w-auto px-3 py-2 text-xs sm:text-sm rounded-lg
                       bg-blue-600 text-white hover:bg-blue-700">
          ì €ì¥
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  const slotModal = document.getElementById("slot-modal");
  const slotForm = document.getElementById("slot-form");
  const slotIdInput = document.getElementById("slot_id_input");
  const slotInfoLabel = document.getElementById("slot_info_label");

  const productSelect = document.getElementById("product_select");

  /* ìƒí’ˆ ì„ íƒ (ìš°ì¸¡ ì¹´ë“œ í´ë¦­ ì‹œ) */
  function selectProduct(id, element) {
    productSelect.value = id;

    document.querySelectorAll(".product-card")
      .forEach(c => c.classList.remove("ring", "ring-blue-500"));

    element.classList.add("ring", "ring-blue-500");
  }

  /* ìŠ¬ë¡¯ ëª¨ë‹¬ ì—´ê¸°/ì´ˆê¸°í™” */
  function attachSlotModalHandlers() {
    document.querySelectorAll(".js-open-slot-modal").forEach(btn => {
      btn.addEventListener("click", () => {
        const card = btn.closest("[data-slot-id]");
        if (!card) return;

        const slotId = card.dataset.slotId;
        const label = card.dataset.slotLabel;
        const board = card.dataset.slotBoard;
        const max = card.dataset.slotMax || 0;
        const stock = card.dataset.slotStock || 0;
        const low = card.dataset.slotLow || 0;
        const productId = card.dataset.slotProductId || "";

        slotIdInput.value = slotId;
        slotInfoLabel.textContent = `${label} (ë³´ë“œì½”ë“œ: ${board})`;

        // ê¸°ì¡´ ì„ íƒ í•´ì œ
        document.querySelectorAll(".product-card")
          .forEach(c => c.classList.remove("ring", "ring-blue-500"));

        // í˜„ì¬ ìŠ¬ë¡¯ì— ì´ë¯¸ ë§¤í•‘ëœ ìƒí’ˆì´ ìˆë‹¤ë©´ í•´ë‹¹ ì¹´ë“œ ê°•ì¡°
        if (productId) {
          const selectedCard = document.querySelector(`.product-card[data-id="${productId}"]`);
          if (selectedCard) {
            selectedCard.classList.add("ring", "ring-blue-500");
          }
        }

        productSelect.value = productId;

        // ğŸ”¹ AJAXìš© JSON ì—”ë“œí¬ì¸íŠ¸ë¡œ action ì„¤ì •
        slotForm.action = `/kiosks/{{ kiosk.id }}/slots/${slotId}/assign-json`;

        slotModal.classList.remove("hidden");
      });
    });
  }

  /* ëª¨ë‹¬ ë‹«ê¸° */
  function attachCloseModalHandlers() {
    document.querySelectorAll(".js-close-slot-modal").forEach(btn => {
      btn.addEventListener("click", () => {
        slotModal.classList.add("hidden");
      });
    });
  }

  //ì›ê²©ë°°ì¶œ
  function confirmRemoteVend(button) {
    const productName = button.getAttribute("data-product-name") || "í•´ë‹¹ ìƒí’ˆ";
    return confirm(productName + "ì„(ë¥¼) ì›ê²©ë°°ì¶œ í•˜ê² ìŠµë‹ˆê¹Œ?");
  }

  /* ìŠ¬ë¡¯ì— ë°°ì¹˜ëœ ìƒí’ˆ ìì²´ ìˆ˜ì • ë²„íŠ¼ í•¸ë“¤ëŸ¬ (ê¸°ì¡´ ë¡œì§ ìœ ì§€) */
  function attachEditSlotProductHandlers() {
    document.querySelectorAll(".js-edit-slot-product").forEach(btn => {
      btn.addEventListener("click", () => {
        const card = btn.closest("[data-slot-id]");
        if (!card) return;

        const kioskProductId = card.dataset.kioskProductId;
        if (!kioskProductId) {
          alert("ì´ ìŠ¬ë¡¯ì—ëŠ” ì•„ì§ ìƒí’ˆì´ ë§¤í•‘ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.");
          return;
        }

        const kioskId = {{ kiosk.id }};
        window.location.href = `/kiosks/${kioskId}/products/${kioskProductId}/edit`;
      });
    });
  }

  /* ìŠ¬ë¡¯ ëª¨ë‹¬ í¼ì„ AJAXë¡œ ì œì¶œí•´ì„œ ë¶€ë¶„ ì—…ë°ì´íŠ¸ */
  function attachSlotFormAjaxSubmit() {
    if (!slotForm) return;

    slotForm.addEventListener("submit", async (event) => {
      event.preventDefault();

      const submitBtn = slotForm.querySelector("button[type='submit']");
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = "ì €ì¥ ì¤‘...";
      }

      const formData = new FormData(slotForm);

      try {
        const res = await fetch(slotForm.action, {
          method: "POST",
          body: formData,
          headers: {
            "X-Requested-With": "XMLHttpRequest",
          },
        });

        if (!res.ok) {
          const text = await res.text();
          console.error("slot assign error:", res.status, text);
          alert("ìŠ¬ë¡¯ ë°°ì¹˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          return;
        }

        const data = await res.json();
        if (!data.ok) {
          alert(data.error || "ìŠ¬ë¡¯ ë°°ì¹˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          return;
        }

      // ğŸ”¹ í•´ë‹¹ ìŠ¬ë¡¯ ì¹´ë“œ DOM ì—…ë°ì´íŠ¸
      const slotId = data.slot_id;
      const card = document.querySelector(`[data-slot-id="${slotId}"]`);
      if (card) {
        // data-* ì—…ë°ì´íŠ¸
        card.dataset.slotMax = data.stock.max_capacity;
        card.dataset.slotStock = data.stock.current_stock;
        card.dataset.slotLow = data.stock.low_stock_alarm;
        card.dataset.slotProductId = data.product.product_id;
        card.dataset.kioskProductId = data.product.kiosk_product_id;

        // ì´ë¦„ / ê°€ê²© / ì¬ê³  í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        const nameEl = card.querySelector("[data-role='slot-product-name']");
        if (nameEl) {
          nameEl.textContent = data.product.name;
        }

        const priceEl = card.querySelector("[data-role='slot-price']");
        if (priceEl) {
          if (data.product.price != null) {
            priceEl.textContent = data.product.price.toLocaleString("ko-KR") + "ì›";
          } else {
            priceEl.textContent = "ê°€ê²© ì •ë³´ ì—†ìŒ";
          }
        }

        const stockEl = card.querySelector("[data-role='slot-stock']");
        if (stockEl) {
          const value = data.stock.current_stock ?? 0;
          stockEl.textContent = value;

          const stockWrapper = card.querySelector("[data-role='slot-stock-wrapper']");
          const labelEl = card.querySelector("[data-role='stock-label']");

          if (stockWrapper && labelEl) {
            if (value === 0) {
              // í’ˆì ˆ ìƒíƒœ
              stockWrapper.classList.add("text-red-500", "font-semibold");
              stockWrapper.classList.remove("text-slate-600");
              labelEl.textContent = "í’ˆì ˆ";
            } else {
              // ì¬ê³  ìˆìŒ
              stockWrapper.classList.remove("text-red-500", "font-semibold");
              stockWrapper.classList.add("text-slate-600");
              labelEl.textContent = "ì¬ê³ ";
            }
          }
        }


        // ğŸ”¹ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ (ì—†ë˜ ìŠ¬ë¡¯ì—ë„ ìƒˆë¡œ ìƒì„±)
        const imgUrl = data.product.image_url;
        const container = card.querySelector("[data-role='slot-image-container']");
        let imgEl = card.querySelector("[data-role='slot-image']");

        if (imgUrl) {
          if (!container) {
            // ì•ˆì „ì¥ì¹˜: ê·¸ë˜ë„ ì»¨í…Œì´ë„ˆê°€ ì—†ìœ¼ë©´ img íƒœê·¸ë§Œ ê°ˆì•„ë¼ì›€
            if (!imgEl) {
              imgEl = document.createElement("img");
              imgEl.setAttribute("data-role", "slot-image");
              imgEl.alt = "";
              imgEl.className = "w-full h-full object-contain";
              imgEl.src = imgUrl;
              card.appendChild(imgEl);
            } else {
              imgEl.src = imgUrl;
            }
          } else {
            // ì»¨í…Œì´ë„ˆê°€ ìˆìœ¼ë©´ ì•ˆìª½ì„ img 1ê°œë¡œ êµì²´
            const newImg = document.createElement("img");
            newImg.setAttribute("data-role", "slot-image");
            newImg.alt = "";
            newImg.className = "w-full h-full object-contain";
            newImg.src = imgUrl;

            container.innerHTML = "";
            container.appendChild(newImg);
          }
        }
      }


        // ëª¨ë‹¬ ë‹«ê¸°
        slotModal.classList.add("hidden");
      } catch (err) {
        console.error(err);
        alert("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ìŠ¬ë¡¯ ë°°ì¹˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      } finally {
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = "ì €ì¥";
        }
      }
    });
  }

  // ì´ˆê¸° ë°”ì¸ë”©
  document.addEventListener("DOMContentLoaded", () => {
    attachSlotModalHandlers();
    attachEditSlotProductHandlers();
    attachCloseModalHandlers();
    attachSlotFormAjaxSubmit();
  });
</script>

{% endblock %}
